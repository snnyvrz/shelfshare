name: Deploy ShelfShare

on:
    workflow_run:
        workflows: ["CI"]
        types:
            - completed

permissions:
    contents: read
    packages: write

env:
    IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/shelfshare-books-api
    APP_SERVICE: books-api

jobs:
    build-and-push:
        name: Build & Push Docker Image
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repo
              uses: actions/checkout@v4

            - name: Log in to GHCR
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ secrets.GHCR_USERNAME }}
                  password: ${{ secrets.GHCR_TOKEN }}

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build and push books-api image
              uses: docker/build-push-action@v6
              with:
                  context: ./apps/books-api
                  file: ./apps/books-api/Dockerfile
                  push: true
                  tags: |
                      ${{ env.IMAGE_NAME }}:latest
                      ${{ env.IMAGE_NAME }}:${{ github.sha }}

    deploy:
        name: Deploy to EC2
        runs-on: ubuntu-latest
        needs: build-and-push

        steps:
            - name: Checkout repo (for docker-compose.prod.yml)
              uses: actions/checkout@v4

            - name: Copy docker-compose.prod.yml to server
              uses: appleboy/scp-action@v0.1.7
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USER }}
                  key: ${{ secrets.EC2_SSH_KEY }}
                  source: "docker-compose.prod.yml"
                  target: "/home/ubuntu/shelfshare"

            - name: Deploy via SSH
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USER }}
                  key: ${{ secrets.EC2_SSH_KEY }}
                  script: |
                      set -e

                      cd /home/ubuntu/shelfshare

                      echo "Pulling latest repo (for env / compose changes)..."
                      git pull || true

                      echo "Logging in to GHCR..."
                      echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u "${{ secrets.GHCR_USERNAME }}" --password-stdin

                      echo "Pulling latest image..."
                      IMAGE="${{ env.IMAGE_NAME }}:latest"

                      docker pull "$IMAGE"

                      echo "Updating docker-compose to use latest image..."
                      # Assumes your docker-compose.prod.yml has image reference like:
                      #   image: ghcr.io/<owner>/shelfshare-books-api:latest
                      # If you use a different tag pattern, adjust this block or rely directly on :latest.

                      echo "Starting containers..."
                      docker compose --env-file .env.prod -f docker-compose.prod.yml up -d --remove-orphans

                      echo "Pruning old images..."
                      docker image prune -af || true
