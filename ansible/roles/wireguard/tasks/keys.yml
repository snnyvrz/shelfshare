- name: Ensure WireGuard config directory exists
  ansible.builtin.file:
    path: /etc/wireguard
    state: directory
    owner: root
    group: root
    mode: "0700"

- name: Generate WireGuard keypair if missing
  ansible.builtin.shell: |
    set -e
    umask 077

    if [ ! -f /etc/wireguard/privatekey ]; then
      # Generate both private + public at once
      wg genkey | tee /etc/wireguard/privatekey | wg pubkey > /etc/wireguard/publickey
    elif [ ! -f /etc/wireguard/publickey ]; then
      # Private exists but public key missing â†’ derive it
      wg pubkey < /etc/wireguard/privatekey > /etc/wireguard/publickey
    fi
  args:
    executable: /bin/bash
  register: wg_keygen
  changed_when: wg_keygen.rc == 0
  no_log: true

- name: Read private key from file
  ansible.builtin.slurp:
    src: /etc/wireguard/privatekey
  register: wg_private_key_file
  no_log: true

- name: Set private key fact
  ansible.builtin.set_fact:
    wg_private_key: "{{ wg_private_key_file.content | b64decode | trim }}"
    cacheable: true
  no_log: true

- name: Read public key from file
  ansible.builtin.slurp:
    src: /etc/wireguard/publickey
  register: wg_public_key_file
  no_log: true

- name: Set public key fact
  ansible.builtin.set_fact:
    wg_public_key: "{{ wg_public_key_file.content | b64decode | trim }}"
    cacheable: true
  no_log: true
